et. AÅŸaÄŸÄ±da sana gerÃ§ek production seviyesinde,
WhatsApp uyumlu, LLM hata riski minimum, Replitâ€™te direkt Ã§alÄ±ÅŸtÄ±rÄ±labilir bir mimari veriyorum.

Bu yapÄ± promptâ€™a gÃ¼venmez, LLMâ€™yi kilitler, deterministik Ã§alÄ±ÅŸÄ±r.
SektÃ¶rde Ã§alÄ±ÅŸan botlarÄ±n %90â€™Ä± buna Ã§ok benzer.

ğŸ§  MÄ°MARÄ° PRENSÄ°P (Ã–NCE BUNU ANLA)
âŒ YanlÄ±ÅŸ
WhatsApp â†’ LLM â†’ Cevap

âœ… DoÄŸru (PRODUCTION)
WhatsApp
 â†“
Intent + Activity Parser (HARD RULES)
 â†“
Conversation State (Activity Lock)
 â†“
Business Rule Engine (IF / ELSE)
 â†“
LLM (SADECE CÃœMLE YAZAR)


âš ï¸ LLM ASLA karar vermez
âš ï¸ LLM ASLA veri seÃ§mez
âš ï¸ LLM ASLA baÄŸlam yÃ¶netmez

ğŸ“ DOSYA YAPISI (REPLIT READY)
/src
 â”œâ”€â”€ index.js              # Express server
 â”œâ”€â”€ webhook.js            # WhatsApp webhook
 â”œâ”€â”€ state.js              # Session & activity lock
 â”œâ”€â”€ intent.js             # Intent + activity detection
 â”œâ”€â”€ rules.js              # Business rules
 â”œâ”€â”€ data.js               # Activity data (tek kaynak)
 â”œâ”€â”€ llm.js                # Optional text beautifier

1ï¸âƒ£ data.js â€“ TEK GERÃ‡EK KAYNAK (SSOT)
export const ACTIVITIES = {
  paragliding: {
    name: "YamaÃ§ ParaÅŸÃ¼tÃ¼",
    price: "6000 TL",
    duration: "25-30 dakika",
    transfer: "Ã–lÃ¼deniz ve Fethiye merkezden Ã¼cretsiz",
    availability: "Her gÃ¼n 09:00 - 18:00"
  },
  rafting: {
    name: "Rafting",
    price: "1500 TL",
    duration: "2-3 saat",
    transfer: "Fethiye Ã§Ä±kÄ±ÅŸlÄ±",
    availability: "GÃ¼nde 2 tur"
  }
};


â¡ï¸ LLM bu dosyayÄ± ASLA gÃ¶rmez

2ï¸âƒ£ state.js â€“ ACTIVITY LOCK (EN KRÄ°TÄ°K PARÃ‡A)
const sessions = new Map();

export function getSession(userId) {
  if (!sessions.has(userId)) {
    sessions.set(userId, {
      activity: null
    });
  }
  return sessions.get(userId);
}

export function setActivity(userId, activity) {
  const session = getSession(userId);
  session.activity = activity;
}

export function resetActivity(userId) {
  const session = getSession(userId);
  session.activity = null;
}


ğŸš¨ Aktivite deÄŸiÅŸince ESKÄ° CONTEXT YOK EDÄ°LÄ°R

3ï¸âƒ£ intent.js â€“ LLM YOK, SADECE KURAL
export function detectIntent(text) {
  text = text.toLowerCase();

  if (text.includes("fiyat")) return "price";
  if (text.includes("kaÃ§ dakika") || text.includes("sÃ¼re")) return "duration";
  if (text.includes("transfer")) return "transfer";
  if (text.includes("saat") || text.includes("mÃ¼sait")) return "availability";
  if (text.includes("rezervasyon")) return "reservation";

  return "activity_info";
}

export function detectActivity(text) {
  text = text.toLowerCase();

  if (text.includes("paraÅŸÃ¼t")) return "paragliding";
  if (text.includes("rafting")) return "rafting";

  return null;
}


âœ… Regex + keyword = %100 kontrol

4ï¸âƒ£ rules.js â€“ Ä°Å AKLIN (ASIL BOT)
import { ACTIVITIES } from "./data.js";

export function handleIntent(intent, activityKey) {
  const activity = ACTIVITIES[activityKey];
  if (!activity) return "Hangi aktivite hakkÄ±nda bilgi almak istersiniz?";

  switch (intent) {
    case "price":
      return `${activity.name} fiyatÄ±mÄ±z ${activity.price}.`;
    case "duration":
      return `${activity.name} sÃ¼resi ${activity.duration}.`;
    case "transfer":
      return activity.transfer;
    case "availability":
      return activity.availability;
    case "activity_info":
      return `${activity.name} hakkÄ±nda bilgi almak ister misiniz?`;
    default:
      return "Size nasÄ±l yardÄ±mcÄ± olabilirim?";
  }
}


â¡ï¸ BROÅÃœR YOK
â¡ï¸ TAHMÄ°N YOK
â¡ï¸ SADECE Ä°STENEN

5ï¸âƒ£ llm.js â€“ OPSÄ°YONEL (Ä°STERSEN)
export function softenText(text) {
  // Ä°stersen Gemini / GPT burada kullanÄ±lÄ±r
  return text; // Åimdilik DÃœZ METÄ°N (en gÃ¼venlisi)
}


âš ï¸ Production botlarÄ±n Ã§oÄŸu burayÄ± BOÅ bÄ±rakÄ±r

6ï¸âƒ£ webhook.js â€“ WHATSAPP ENTRY POINT
import { getSession, setActivity } from "./state.js";
import { detectIntent, detectActivity } from "./intent.js";
import { handleIntent } from "./rules.js";
import { softenText } from "./llm.js";

export function handleMessage(userId, message) {
  const session = getSession(userId);

  const newActivity = detectActivity(message);
  if (newActivity) {
    setActivity(userId, newActivity);
  }

  const intent = detectIntent(message);

  const reply = handleIntent(intent, session.activity);
  return softenText(reply);
}

7ï¸âƒ£ index.js â€“ EXPRESS (REPLIT READY)
import express from "express";
import { handleMessage } from "./webhook.js";

const app = express();
app.use(express.json());

app.post("/webhook", (req, res) => {
  const userId = req.body.user;
  const text = req.body.text;

  const reply = handleMessage(userId, text);
  res.json({ reply });
});

app.listen(3000, () => console.log("Bot running"));

âœ… BU YAPI NEYÄ° GARANTÄ°LER?

âœ” YanlÄ±ÅŸ aktivite anlatmaz
âœ” BroÅŸÃ¼r gibi konuÅŸmaz
âœ” â€œRafting?â€ deyince paraÅŸÃ¼t anlatmaz
âœ” LLM halÃ¼sinasyonu = 0â€™a yakÄ±n
âœ” WhatsApp iÃ§in en gÃ¼venli mimari

ğŸ”¥ SON NET TESPÄ°T

Gemini 2.5 Flash yeterli mi?

âœ” EVET, hatta bu mimaride:

GPT-4 gerekmez

Claude gerekmez

LLM kapalÄ± bile Ã§alÄ±ÅŸÄ±r

AkÄ±l kodda, LLM sÃ¼s.